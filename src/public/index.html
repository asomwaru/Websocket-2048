<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/index.css" />
    <script type="module" src="/static/game.js"></script>
    <title>Competitive 2048</title>
  </head>

  <body>
    <div class="grid" id="grid">
      <div></div>
      <div></div>
      <div></div>
      <div></div>

      <div></div>
      <div></div>
      <div></div>
      <div></div>

      <div></div>
      <div></div>
      <div></div>
      <div></div>

      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
  </body>

  <script src="/socket.io/socket.io.js"></script>
  <script type="module">
    import * as board from "/static/game.js";

    function oneDimtoTwoDim(grid) {
      let tempArr = [];
      grid = [].concat(grid);

      while (grid.length) tempArr.push(grid.splice(0, 4));

      return tempArr;
    }

    function getGrid() {
      let gridElm = document.getElementById("grid");

      return [...gridElm.children].map((item) =>
        item.innerText ? parseInt(item.innerText) : 0
      );
    }

    function placeNum(grid) {
      let validSpots = [];

      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (grid[i][j] === 0) {
            validSpots.push([i, j]);
          }
        }
      }

      validSpots = validSpots.filter((num) => grid[num[0]][num[1]] === 0);

      let [row, col] =
        validSpots[Math.floor(Math.random() * validSpots.length)];

      let elm = document.getElementById("grid").children[row * 4 + col];
      let num = Math.random() > 0.75 ? 2 : 4;

      elm.innerHTML = num;
      elm.classList.add("n" + num);
      grid[row][col] = num;
    }

    function getMax(grid) {
      return Math.max(...grid);
    }

    function updatePage(grid) {
      let tempArr = grid.flat();

      let board = document.getElementById("grid");
      tempArr.map((item, i) => {
        if (item !== 0) {
          board.children[i].innerHTML = item;
          board.children[i].className = `n${item}`;
        } else {
          board.children[i].innerHTML = "";
          board.children[i].className = "";
        }
      });
    }

    let oneGrid = getGrid();
    let twoGrid = oneDimtoTwoDim(oneGrid);
    let connected = false;
    let id = 0;

    const socket = io("http://localhost:8080");

    socket.on("hello", () => {
      console.log("Got a message");
    });

    socket.on("give_id", ({ num }) => {
      id = num;

      console.log(`Got a new id: ${id}`);
    });

    socket.on("update", (args) => {
      if (args.id !== id) {
        console.table(args.opponent);
      }
    });

    window.addEventListener("keydown", (event) => {
      /*
      left: 37
      right: 39
      up: 38
      down: 40
      */

      let checkedMove;

      if (event.keyCode === 37) {
        oneGrid = getGrid();
        checkedMove = board.checkLeft(oneGrid);

        if (checkedMove) {
          oneGrid = checkedMove;

          twoGrid = oneDimtoTwoDim(oneGrid);
          placeNum(twoGrid);
          updatePage(twoGrid);

          socket.emit("receive", { id, board: twoGrid });
        }
      }

      if (event.keyCode === 39) {
        oneGrid = getGrid();
        checkedMove = board.checkRight(oneGrid);

        if (checkedMove) {
          oneGrid = checkedMove;

          twoGrid = oneDimtoTwoDim(oneGrid);
          placeNum(twoGrid);
          updatePage(twoGrid);

          socket.emit("receive", { id, board: twoGrid });
        }
      }

      if (event.keyCode === 38) {
        oneGrid = getGrid();
        checkedMove = board.checkUp(oneGrid);

        if (checkedMove) {
          oneGrid = checkedMove;

          twoGrid = oneDimtoTwoDim(oneGrid);
          placeNum(twoGrid);
          updatePage(twoGrid);

          socket.emit("receive", { id, board: twoGrid });
        }
      }

      if (event.keyCode === 40) {
        oneGrid = getGrid();
        checkedMove = board.checkDown(oneGrid);

        if (checkedMove) {
          oneGrid = checkedMove;

          twoGrid = oneDimtoTwoDim(oneGrid);
          placeNum(twoGrid);
          updatePage(twoGrid);

          socket.emit("receive", { id, board: twoGrid });
        }
      }
    });

    window.addEventListener("load", (event) => {
      event.preventDefault();

      placeNum(twoGrid);
      placeNum(twoGrid);

      oneGrid = getGrid();
      twoGrid = oneDimtoTwoDim(oneGrid);

      socket.emit("waiting");
    });
  </script>
</html>
